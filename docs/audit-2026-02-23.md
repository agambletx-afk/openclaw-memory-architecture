# Codebase Audit — 2026-02-23

Scope: repository-wide static audit for correctness bugs, security risks, consistency issues, and maintainability improvements.

## Findings

### 1) Shell command construction with interpolated query text in benchmark helper
- **Classification:** SECURITY
- **Severity:** Medium
- **Where:** `scripts/memory-telemetry.js`
- **Evidence:** The benchmark builds a shell command string and invokes `execSync(...)` with an interpolated query payload (`"${gq.query}"`) and a hardcoded absolute script path. This runs through a shell and depends on manual quoting. If query sources are ever made dynamic, this becomes command-injection prone.
- **Proposed fix:**
  1. Replace `execSync(string)` with `execFileSync('python3', [scriptPath, gq.query], { shell: false })`.
  2. Resolve `scriptPath` from workspace/env instead of a user-specific absolute path.
  3. Keep stderr handling explicit via options rather than shell redirection (`2>/dev/null`).

### 2) Hardcoded user-specific DB path in graph search script
- **Classification:** BUG
- **Severity:** High
- **Where:** `scripts/graph-search.py`
- **Evidence:** `DB_PATH`/legacy fallback are initialized to `/home/coolmann/.openclaw/data/facts.db`, which is not portable across machines/CI.
- **Proposed fix:**
  1. Default to workspace-relative `memory/facts.db` when no CLI/env path is provided.
  2. Keep legacy fallback as opt-in compatibility mode only.
  3. Emit a single startup warning when legacy fallback is used.

### 3) Placeholder workspace defaults break ingestion and pruning out of the box
- **Classification:** BUG
- **Severity:** High
- **Where:** `scripts/graph-ingest-daily.py`, `scripts/prune-memory.py`
- **Evidence:** Both scripts still default to `/path/to/workspace/...` for critical paths.
- **Proposed fix:**
  1. Add common path-resolution helper (`--workspace` CLI arg → `OPENCLAW_WORKSPACE` env → `cwd`).
  2. Validate resolved directories/files at startup with actionable errors.
  3. Remove placeholder fallback constants from runtime code.

### 4) Database handles can remain open on early-return paths
- **Classification:** BUG
- **Severity:** Medium
- **Where:** `scripts/query-facts.py`
- **Evidence:** Several code paths return early (`--stats`, exact lookup, help/no-input) before `db.close()` at function tail.
- **Proposed fix:**
  1. Wrap DB usage in `with sqlite3.connect(...) as db:` or `try/finally`.
  2. Keep current behavior but guarantee close on all exit paths.

### 5) Duplicate/conflicting top-level DB path assignments reduce clarity
- **Classification:** CONSISTENCY
- **Severity:** Low
- **Where:** `scripts/graph-search.py`
- **Evidence:** `DB_PATH` is assigned twice at module scope; the first assignment is immediately overridden.
- **Proposed fix:**
  1. Keep a single source of truth for defaults (`DEFAULT_LEGACY_DB_PATH`) and initialize once.
  2. Add a brief comment documenting precedence order for runtime resolution.

### 6) Exception swallowing hides recoverability/observability signals
- **Classification:** ENHANCEMENT
- **Severity:** Medium
- **Where:** `scripts/graph-search.py`, `plugin-graph-memory/index.js`
- **Evidence:** Multiple broad catches suppress detail (e.g., alias-table lookup path and optional module loading fallbacks), making diagnosis harder when behavior regresses.
- **Proposed fix:**
  1. Narrow catch scope to expected error classes/codes.
  2. Add debug-only diagnostics (`--debug` / config flag) with short contextual metadata.
  3. Surface aggregate warning counters in CLI/plugin startup output.

---

## Proposed fix plan (logical commits)

### Commit A — Secure benchmark execution path
- Replace shell-based `execSync` graph benchmark invocation with argument-safe `execFileSync`.
- Remove hardcoded absolute benchmark script paths and use workspace/env resolution.
- **Covers:** Finding #1.

### Commit B — Path portability hardening across Python scripts
- Normalize workspace/db resolution in `graph-search`, `graph-ingest-daily`, and `prune-memory`.
- Remove placeholder defaults from runtime execution paths.
- **Covers:** Findings #2, #3, #5.

### Commit C — Reliability improvements for DB lifecycle and diagnostics
- Ensure `query-facts.py` always closes DB connections.
- Tighten broad exception handling and add targeted debug diagnostics.
- **Covers:** Findings #4, #6.
