# Codebase Audit — 2026-02-23

This audit reviews bugs, security concerns, and code quality issues across the repository, prioritized by severity.

## Priority 0 (Critical)

### 1) Raw user prompts are logged to stdout in the graph-memory plugin
- **Classification:** SECURITY
- **Severity:** Critical
- **Where:** `plugin-graph-memory/index.js`
- **Evidence:** `_stripContextBlocks()` logs raw and cleaned user text with `console.log`, including potentially sensitive prompt data.
- **Risk:** Prompt contents can include secrets/PII and are currently emitted to process logs, which may be persisted, forwarded, or accessible to other operators.
- **Proposed fix:**
  1. Remove raw prompt logging entirely.
  2. Gate optional diagnostics behind an explicit `debug` config flag and redact payload values (length-only or hash-only).
  3. Keep telemetry structured and avoid storing full prompt bodies by default.

## Priority 1 (High)

### 2) Hardcoded absolute database path breaks graph search portability
- **Classification:** BUG
- **Severity:** High
- **Where:** `scripts/graph-search.py`
- **Evidence:** `DB_PATH` is fixed to `/home/coolmann/.openclaw/data/facts.db`.
- **Risk:** Script fails or reads the wrong database in any environment that does not match this local path, causing silent relevance regressions.
- **Proposed fix:**
  1. Resolve DB path from `--db-path` CLI argument first.
  2. Fallback to `OPENCLAW_WORKSPACE` + `memory/facts.db`.
  3. Keep existing path only as final legacy fallback with an explicit warning.

### 3) Graph initialization/export scripts default to placeholder paths
- **Classification:** BUG
- **Severity:** High
- **Where:** `scripts/graph-init.py`, `scripts/graph-export.py`
- **Evidence:** Both files default to `/path/to/workspace/...` constants.
- **Risk:** Out-of-box command execution fails with `No such file or directory`, making onboarding and CI automation brittle.
- **Proposed fix:**
  1. Replace placeholders with runtime path resolution based on `OPENCLAW_WORKSPACE`.
  2. Add `--db-path` / `--out-path` arguments.
  3. Validate existence early with actionable error messages.

## Priority 2 (Medium)

### 4) Telemetry writer assumes `/tmp/openclaw` exists
- **Classification:** CONSISTENCY
- **Severity:** Medium
- **Where:** `plugin-graph-memory/index.js`
- **Evidence:** `fs.appendFile('/tmp/openclaw/memory-telemetry.jsonl', ...)` is called without directory creation.
- **Risk:** Repeated write failures in clean environments create noisy logs and reduce observability.
- **Proposed fix:**
  1. Ensure parent directory exists (`fs.mkdirSync(dir, { recursive: true })`) during plugin startup.
  2. Allow telemetry path override via config.
  3. Fail soft once and suppress repeated identical errors.

### 5) Broad exception swallowing obscures operational failures
- **Classification:** ENHANCEMENT
- **Severity:** Medium
- **Where:** `scripts/memory-benchmark.py`, `scripts/graph-search.py`
- **Evidence:** Multiple `except Exception: pass` blocks hide parse/runtime errors.
- **Risk:** Benchmark and search behavior can degrade silently, producing misleading pass/fail rates.
- **Proposed fix:**
  1. Narrow exception types.
  2. Emit optional `--debug` diagnostics with concise error context.
  3. Count and surface backend errors in final benchmark summary.

## Priority 3 (Low)

### 6) Inconsistent workspace path strategy across scripts/plugins
- **Classification:** CONSISTENCY
- **Severity:** Low
- **Where:** `scripts/*` + `plugin-graph-memory/index.js`
- **Evidence:** Mix of placeholder paths, user-specific home paths, and environment-based resolution.
- **Risk:** Increased maintenance burden and avoidable deployment variance.
- **Proposed fix:**
  1. Standardize a shared path-resolution helper contract:
     - `--workspace` CLI arg
     - `OPENCLAW_WORKSPACE` env fallback
     - current working directory fallback
  2. Document the contract in `README.md`.

---

## Proposed logical commit / PR grouping

### PR A — Security hardening for graph-memory logging
- Remove raw prompt debug logs.
- Add redacted, opt-in debug mode.
- Harden telemetry defaults and retention behavior.
- **Issues covered:** #1, #4

### PR B — Path portability and CLI ergonomics for graph scripts
- Replace hardcoded and placeholder paths with runtime resolution.
- Add explicit CLI options and startup validation.
- **Issues covered:** #2, #3, #6

### PR C — Reliability/observability improvements for search+benchmark
- Replace broad exception swallowing.
- Add debug diagnostics and backend error counters.
- Improve benchmark reporting for backend failures.
- **Issues covered:** #5
